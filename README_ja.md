# Fusion 360 ボロノイパターンジェネレーター

板金パーツやレーザーカット用に、平面にボロノイ軽量化穴パターンを生成する Fusion 360 アドインです。

![ボロノイパターンプレビュー](docs/preview.png)
<!-- 実際のスクリーンショットに差し替えてください -->

## 特徴

- 任意の平面にボロノイセルパターンを生成
- パラメータ調整可能：シード数、リブ幅、エッジマージン、角丸め半径
- 面の穴（ボルト穴など）を自動検出し、マージン付きで回避
- マウントホール除外ゾーン（円形エッジを選択して保護）
- マウントホール付近の密度勾配オプション（強度確保）
- ランダムシードによる再現可能なパターン
- 純 Python 実装 — 外部依存なし

## インストール

1. リポジトリをクローン:
   ```bash
   git clone https://github.com/nori-ut3g/fusion360-voronoi-pattern.git
   ```

2. `VoronoiPattern` フォルダを Fusion 360 のアドインディレクトリにコピーまたはシンボリックリンク:

   **Windows:**
   ```
   %APPDATA%\Autodesk\Autodesk Fusion 360\API\AddIns\
   ```

   **macOS:**
   ```
   ~/Library/Application Support/Autodesk/Autodesk Fusion 360/API/AddIns/
   ```

3. Fusion 360 を起動 → ツール → アドイン → **VoronoiPattern** を有効化

## 使い方

1. 平面を持つデザインを開く（例：板金パーツ）
2. **ツール** → **Voronoi Pattern** を選択
3. パターンを適用する**平面**を選択
4. （オプション）除外する**円形エッジ**（マウントホール）を選択
5. パラメータを調整:

   | パラメータ | デフォルト | 説明 |
   |---|---|---|
   | Seed Count | 40 | ボロノイセルの数（10〜200） |
   | Min Rib Width | 3.0 mm | 穴間の最小リブ幅 |
   | Edge Margin | 5.0 mm | 面の端からのマージン |
   | Hole Margin | 2.0 mm | 検出された穴周囲のマージン |
   | Corner Radius | 1.0 mm | 穴の角の丸め半径（0で直線） |
   | Random Seed | 42 | パターン再現用の乱数シード |
   | Density Gradient | On | マウントホール付近のセル密度を上げる |

6. **OK** をクリック → ボロノイパターンのスケッチが作成される
7. **押し出し → カット** で穴を開ける

### ヒント

- 面に既存の穴（ボルト穴など）がある場合、自動的に検出されます。Hole Margin で指定した距離だけ穴の周囲にマージンが確保されます。
- **Seed Count** を増やすと小さなセルが多くなり、減らすと大きなセルが少なくなります。
- **Corner Radius** を 0 にすると角が直角になります（レーザーカット向け）。
- 同じ **Random Seed** を使えば、何度実行しても同じパターンが再現されます。
- エッジ付近にセルが生成されない場合は、**Edge Margin** を小さくしてみてください。

## アルゴリズム

パターン生成は以下の7段階のパイプラインで処理されます：

### 1. 境界・穴の抽出

選択された面の外郭ループをスケッチ空間座標のポリゴンとして抽出します（`modelToSketchSpace()` で変換）。内側ループ（ボルト穴やカットアウト）も抽出し、Hole Margin 分だけ外側に拡張します。

### 2. シード生成

面の境界内にランダムなシード点を配置します（リジェクションサンプリング）：
- 各点は境界辺から `edge_margin` 以上離れている必要がある
- 除外ゾーン（円形エッジ＋拡張穴ポリゴン）の外側にある必要がある
- **Density Gradient** が有効な場合、除外ゾーン付近の受理確率を距離に基づいて重み付けし、セル密度を上げる

### 3. ボロノイ分割（Bowyer-Watson法）

Bowyer-Watson 増分アルゴリズムでドロネー三角分割を計算し、双対変換でボロノイ図を生成します：

1. **ドロネー三角分割**: シード点を1つずつ追加し、新しい点を外接円内に含む三角形を削除して再三角分割
2. **ボロノイ双対変換**: 各シードに隣接する三角形の外接円中心がボロノイセルの頂点となり、シード周りの角度でソート

**境界ガードシード**: 面の境界付近のセルが正しく閉じるよう、境界ポリゴンに沿って一定間隔でガードシードを外側に配置します。実際の面形状に追従するため、コーナーや非矩形の境界でも確実にセルが閉じます（従来のバウンディングボックスミラー方式の問題を解決）。

### 4. クリッピング

各ボロノイセルを2段階でクリップします：
1. **広域バウンディングボックスクリップ** — 無限遠のボロノイ頂点を除去
2. **境界クリップ**（任意ポリゴン対応のSutherland-Hodgman法） — インセット境界（`境界 - rib_width/2`）でクリップし、エッジマージンを確保

### 5. セルオフセット

クリップ済みセルを `rib_width / 2` だけ内側にオフセットします（重心スケーリング方式）：
```
scale = (内接円半径 - distance) / 内接円半径
頂点' = 重心 + (頂点 - 重心) × scale
```
これにより隣接セル間にリブ（構造材料）が生まれます。オフセット後に面積が小さすぎるセル（< 0.005 cm²）は除外されます。

### 6. 穴の除外

拡張穴ポリゴンに対して `clip_polygon_outside` でセルをクリップします：
- 穴がセル内に完全に含まれる場合、薄いスリット（ブリッジ）で穴付きポリゴンを単純ポリゴンに変換し、Fusion 360 が閉じたプロファイルとして認識できるようにします
- セルが穴と部分的に重なる場合、Sutherland-Hodgman法で穴の外側部分のみを保持

### 7. 角丸め＆スケッチ描画

各セルに対して：
1. **簡略化**: `corner_radius` より短い辺を統合し、退化した円弧の生成を防止
2. **角丸め**: 各凸頂点を、隣接する2辺に接する円弧に置換。フィレット半径は短い方の辺の40%以下にクランプしてオーバーラップを防止。170°超の鈍角は直線のまま維持。
3. **描画**: 直線は `addByTwoPoints`、円弧は `addByThreePoints` を使用。円弧の生成に失敗した場合は自動的に直線にフォールバック。全操作は `isComputeDeferred = True` でバッチ処理し、パフォーマンスを確保。

## スタンドアロンテスト

アルゴリズムモジュール（`lib/`）は Fusion 360 に依存せず、単独でテスト可能です：

```bash
pip install pytest
pytest tests/ -v
```

## プロジェクト構成

```
VoronoiPattern/           # Fusion 360 アドインフォルダ
├── VoronoiPattern.py     # アドインのエントリポイント＆UI
├── VoronoiPattern.manifest
├── lib/
│   ├── voronoi.py        # Bowyer-Watson ドロネー → ボロノイ
│   ├── polygon.py        # クリッピング、オフセット、角丸め、穴除外
│   ├── seed_generator.py # 除外ゾーン対応のシード点生成
│   └── sketch_drawer.py  # Fusion スケッチ描画（円弧フォールバック付き）
├── config/
│   └── defaults.json     # デフォルトパラメータ
└── resources/            # アイコン
tests/
├── test_voronoi.py       # ボロノイ計算テスト
├── test_polygon.py       # ポリゴン操作テスト
├── test_seed_generator.py # シード生成テスト
└── visualize.py          # matplotlib プレビュー
```

## 制限事項

- 平面のみ対応（曲面は未対応）
- シード数は最大約 200（それ以上はパフォーマンスが低下する可能性あり）
- スケッチジオメトリのみ作成 — 押し出しカットは手動で実行

## ライセンス

[MIT](LICENSE)
